  <?php  
   
   
   // procédure d'envoi de mail à 19 de synthèse des logs fonctionnel et technique au gestionnaire de site
    function 	exploit_envoi_mail_synthese()
	{
	$jour = date('Y-m-d',  time());
	$hier = date('Y-m-d H\hi',  mktime(date("H") ,date("i")-10, 0  , date("m"), date("d")-1, date ("Y")) );
	
	$txt="<div  ><table><tr><td > Date </td><td> IP</td><td> Action </td><td> Compte </td><td> Acteur </td>";
	$reponse =command("","select * from  log  where date>'$hier' ");		
	while ($donnees = mysql_fetch_array($reponse) ) 
		{
		$date=$donnees["date"];	
		$ligne=$donnees["ligne"];
		$user=$donnees["user"];
		if (is_numeric($donnees["user"]))
			$user=libelle_user($donnees["user"]);
		$acteur=$donnees["acteur"];
		if (is_numeric($donnees["acteur"]))
			$acteur=libelle_user($donnees["acteur"]);
		$ip=$donnees["ip"];
		$txt.="<tr><td>  $date   </a></td><td> $ip </td><td> $ligne </td><td> $user </td><td> $acteur </td>";
		}
	$txt.="</table></div>";
	
	envoi_mail(parametre('DD_mail_gestinonnaire'),"Synthèse $jour ",$txt);
			

	$txt= "<div  ><table><tr><td >   </td><td> </td><td> </td>";
	$reponse =command("","select * from  z_log_t where date>'$hier' ");		
	while ($donnees = mysql_fetch_array($reponse) ) 
		{
		$date=$donnees["date"];	
		$ligne=$donnees["ligne"];
		$ip=$donnees["ip"];
		$txt.= "<tr><td>  $date   </a></td><td> $ip </td><td> $ligne </td>";
		}
	$txt.="</table></div>";
	
	envoi_mail(parametre('DD_mail_gestinonnaire'),"Synthèse $jour ",$txt);

	}
	
	
	
 function titre_kpi()
	{
	echo "<p><table><tr><td></td><td># Admin</td><td># Resp </td><td># AS</td><td># Béné.</td><td># Cx</td><td># Echec Cx </td><td># Chgt doc </td><td># Supp doc </td><td># Doc </td><td> Vol Mo</td> ";

	}
	
function indicateurs()
	{
	$ancien_ttt=parametre("TECH_date_dernier_ttt");
	Echo "Dernier traitment z_TTT :".date('Y-m-d H\hi.s',$ancien_ttt)." Il y a ".(time()-$ancien_ttt). "sec";	

	
	titre_kpi();
	
	$date=date('Y-m-d',  mktime(0,0,0 , date("m"), date("d")-1, date ("Y")));
	kpi("$date");
	
	$date=date('Y-m-d',  mktime(0,0,0 , date("m"), date("d")-7, date ("Y")));
	kpi("$date");
	
	$date=date('Y-m-d',  mktime(0,0,0 , date("m")-1, date("d"), date ("Y")));
	kpi("$date");
	
	$date=date('Y-m-d',  mktime(0,0,0 , date("m")-3, date("d"), date ("Y")));
	kpi("$date");
	
	kpi("");
	
	$r1 = command("","SELECT table_schema,round(sum(data_length+index_length)/1024) as taille FROM information_schema.tables WHERE table_schema = 'doc-depot' ");
	$donnees = mysql_fetch_array($r1);
	$taille=$donnees["taille"];
	$taille_max = parametre("DD_taille_SQL_Mo") ;
	Echo "<Table><tr><td> Volume BdD</td> <td> ".intval($taille). " Ko / $taille_max Mo</td><td> (".sprintf("%2.2f",$taille/$taille_max/10). "%)</td> </Table> "; 
	}

	function kpi_log($d,$crit)
		{
	if ($d=="")
		$date="";
	else
		$date  = "and date>'$d 00h00.00'" ;		
			
		$r1 = command("","SELECT DISTINCT count(*) FROM log WHERE ligne regexp '$crit' $date  ");
		$r2 = mysql_fetch_row($r1);
		Echo "<td>".$r2[0]."</td>"; 
	
		}
		
function kpi($d)
	{
	echo "<tr>";

	if ($d=="")
		echo "<td> Total</td>";
	else
		Echo "<td>Depuis $d </td>";
		
	if ($d=="")
		$date="";
	else
		$date  = "and creation>'$d 00h00.00'" ;		
	$r1 = command("","SELECT DISTINCT count(*) FROM r_user WHERE droit='A' $date ");
	$r2 = mysql_fetch_row($r1);
	Echo "<td>".$r2[0]."</td>"; 

	$r1 = command("","SELECT DISTINCT count(*) FROM r_user WHERE droit='R' $date   ");
	$r2 = mysql_fetch_row($r1);
	Echo "<td>".$r2[0]."</td>"; 

	
	$r1 = command("","SELECT DISTINCT count(*) FROM r_user WHERE droit='S' $date  ");
	$r2 = mysql_fetch_row($r1);
	Echo "<td>".$r2[0]."</td>"; 

	
	$r1 = command("","SELECT DISTINCT count(*) FROM r_user WHERE droit='' $date  ");
	$r2 = mysql_fetch_row($r1);
	Echo "<td>".$r2[0]."</td>"; 
	

	kpi_log($d,"Connexion");
	kpi_log($d,"Echec Connexion");
	kpi_log($d,"Chargement fichier");
	kpi_log($d,"Suppression fichier");
	
	if ($d=="")
		$date="";
	else
		$date  = "where date>'$d 00h00'" ;
	$r1 = command("","SELECT DISTINCT count(*) FROM r_attachement $date  ");
	$r2 = mysql_fetch_row($r1);
	Echo "<td> ".$r2[0]. "</td> "; 		
	
	$nb_abs=0;
	if ($d=="")	
		echo "</table> <p> Fichiers manquants : ";
		
		$taille=0;
		$r1 = command("","SELECT * FROM r_attachement $date  ");
		while ($donnees = mysql_fetch_array($r1) ) 
			{
			$nom1 = "upload/".$donnees["num"];	
			if (!file_exists($nom1))
				{
				$nb_abs++;
				if ($d=="")
					echo "<br> -  $nom1 --->  UPLOAD Absent!";
				}
			else
				$taille+= filesize( $nom1 )/1024/1024;
			
			$nom1 = "upload_chi/".$donnees["num"].".chi";
			if (!file_exists($nom1))
				{
				$nb_abs++;
				if ($d=="")	
					echo "<br> - $nom1 Absent! + regénégration ";
				encrypt_fichier("upload/".$donnees["num"],$nom1);
				}
			else
				$taille+= filesize( $nom1 )/1024/1024;
			
			$ref=$donnees["ref"];
			
			if (!est_doc($donnees["num"]))
				{
				if($ref[0]=="A")
					{
					$nom1 = "upload_pdf/".$donnees["num"].".pdf";
					if (!file_exists($nom1))
						{
						$nom1 = "upload_pdf/".$donnees["num"];
						if (!file_exists($nom1))
							{
							$nb_abs++;
							if ($d=="")
								echo "<br> - $nom1 Absent!";
							}
						else			
							$taille+= filesize( $nom1 )/1024/1024;
						}
					else			
						$taille+= filesize( $nom1 )/1024/1024;
						
					$nom1 = "upload_prot/".$donnees["num"].".pdf";
					if (!file_exists($nom1))
						{
						$nom1 = "upload_prot/".$donnees["num"];
						if (!file_exists($nom1))
							{
							$nb_abs++;
							if ($d=="")
							echo "<br> - $nom1 Absent!";
							}
						else
							$taille+= filesize( $nom1 )/1024/1024;
						}
					else
						$taille+= filesize( $nom1 )/1024/1024;
					}
				}
			}


			
		if ($d=="")	
			{
			if ($nb_abs==0) 
				echo " Aucun";
			$taille_max = parametre("DD_taille_Espace_Go ") ;
			
			Echo "<Table><tr><td> Volume total</td> <td> ".intval($taille). " Mo/ $taille_max Go</td><td> (".sprintf("%2.2f",$taille/$taille_max/10). "%)</td> </Table> "; 			
			}
		else
			Echo "<td> ".intval($taille). " </td> "; 			
	

	}

	
	function maj_signature($hash_libelle, $chemin1_fichier, $num, $aff= false)
		{
		$ancien = fopen($chemin1_fichier, "rb");
		$line = fread($ancien, filesize($chemin1_fichier));		
		$hash=md5 ($line) ;
		
		command("","UPDATE `r_attachement` SET $hash_libelle='$hash' where num='$num' ");
		if ($aff) 
			Echo "<td> Maj </td> ";		
		ajout_log_tech( "$num : Maj $hash_libelle")	;	
		}
	
	
	// vérification de la signature d'un fichier en particulier
	function ctrl_une_signature($hash_libelle, $chemin1_fichier, $num, $aff= false)
		{

		if (!file_exists($chemin1_fichier))
			$chemin1_fichier.=".pdf";
				
		if (file_exists($chemin1_fichier))
			{
			$ancien = fopen($chemin1_fichier, "rb");
			$line = fread($ancien, filesize($chemin1_fichier));		
			$hash=md5 ($line) ;
			$r1 = command("","SELECT * FROM r_attachement where num='$num'  ");
			$donnees = mysql_fetch_array($r1);
			$hash_ref=$donnees["$hash_libelle"];
			if ($hash_ref=="")
				{
				command("","UPDATE `r_attachement` SET $hash_libelle='$hash' where num='$num' ");
				if ($aff) 
					Echo "<td> Maj </td> ";		
				ajout_log_tech( "$num : Maj $hash_libelle")	;	
				return (false);				
				}
				else
					{
					if ($hash_ref!=$hash)
						{
						if ($aff) 
							Echo "<td>Erreur Intégrité</td>";
						ajout_log_tech( "$num : Absence fichier alors que $hash_libelle présent");
						return (false);
						}
					}
			}
		else
			{
			$r1 = command("","SELECT * FROM r_attachement where num='$num'  ");
			$donnees = mysql_fetch_array($r1);
			$hash_ref=$donnees["$hash_libelle"];
			if ($hash_ref!="")
				{
				if ($aff) 
					Echo "<td>Fichier absent</td>";
				return (false);
				}
			else
				{
				Echo "<td> </td>";
				return(true);
				}
			}
		if ($aff) 
			Echo "<td> ok </td>";
		return(true);
		}

	function ctrl_signature_user( $idx, $aff= false )
		{
		$r1 = command("","SELECT * FROM r_attachement where ref='A-$idx' or ref='P-$idx' ");
		while ($donnees = mysql_fetch_array($r1) ) 
			{
			$num=$donnees["num"];
			if ($aff) 
				echo "<tr> <td> $num </td>";
			ctrl_une_signature("hash_chi", "upload_chi/".$num.".chi" , $num, $aff);
			ctrl_une_signature("hash", "upload/".$num, $num, $aff);			
			ctrl_une_signature("hash_pdf", "upload_pdf/".$num, $num, $aff);			
			ctrl_une_signature("hash_prot", "upload_prot/".$num, $num, $aff);
			ctrl_une_signature("hash_mini", "upload_mini/".$num, $num, $aff);
			}
		maj_last_hash_ctrl($idx);
		}
		
	function ctrl_signature( $aff = false )
		{
		if ($aff) 
				echo "<table><tr> <td> </td><td> CHI </td><td> Upload </td><td> PDF </td><td> Prot </td><td> mini </td>";
		$r1 = command("","SELECT * FROM r_attachement ");
		while ($donnees = mysql_fetch_array($r1) ) 
			{
			$num=$donnees["num"];
			$idx=substr($donnees["ref"],2);
			maj_last_hash_ctrl($idx);
			if ($aff) 
				echo "<tr> <td> $num </td>";
			ctrl_une_signature("hash_chi", "upload_chi/".$num.".chi" , $num, $aff);
			ctrl_une_signature("hash", "upload/".$num, $num, $aff);			
			ctrl_une_signature("hash_pdf", "upload_pdf/".$num, $num, $aff);			
			ctrl_une_signature("hash_prot", "upload_prot/".$num, $num, $aff);
			ctrl_une_signature("hash_mini", "upload_mini/".$num, $num, $aff);
			}
		if ($aff) 
				echo "</table>  ";
		}

		
	function verif_user_bdd( $table, $champ, $blanc=false )
		{
		echo "<p> Verification user ($champ) dans $table ";
		$n=0;
		
		$r1 = command("","SELECT * FROM $table ");
		while ($donnees = mysql_fetch_array($r1) ) 
			{
			$n++;
			$idx=$donnees["$champ"];
			if ((!$blanc) || ($idx!=""))
				{
				$r2 = command("","SELECT * FROM `r_user` WHERE  idx='$idx' ");
				if (! mysql_fetch_array($r2) ) 	
					// clé absente
					echo "$idx?, ";
				}
			}
		echo " ($n)";
		}	
	
	function verif_organisme_bdd( $table, $champ , $blanc=false )
		{
		echo "<p> Verification organisme ($champ) dans $table ";
		$n=0;
		
		$r1 = command("","SELECT * FROM $table ");
		while ($donnees = mysql_fetch_array($r1) ) 
			{
			$n++;
			$idx=$donnees["$champ"];
			if ((!$blanc) || ($idx!=""))
				{
				$r2 = command("","SELECT * FROM `r_organisme` WHERE  idx='$idx' ");
				if (! mysql_fetch_array($r2) ) 	
					// clé absente
					echo "$idx?, ";
				}
			}
		echo " ($n)";

		}	

	function verif_integrite_bdd( $aff = false )
		{
		verif_user_bdd ( "r_sms", "idx");
		verif_user_bdd ( "r_referent", "user");
		verif_user_bdd ( "r_lien", "user");
		verif_user_bdd ( "r_dde_acces", "user");
		verif_user_bdd ( "r_dde_acces", "ddeur");
		verif_user_bdd ( "r_dde_acces", "autorise", true);

		verif_user_bdd ( "dd_rdv", "user");

		verif_organisme_bdd ( "r_lien", "organisme");
		verif_organisme_bdd ( "r_referent", "organisme", true);
		
		echo "<hr>Autres non significatifs<p>";
		verif_user_bdd ( "log", "user",true);
		verif_user_bdd ( "log", "acteur",true);
		}		

		
	function fichiers_en_trop()
		{
		Echo "<p> Fichiers en trop : ";
		en_trop ('upload/', true) ;
		en_trop ('upload_chi/', true) ;
		en_trop ('upload_mini/', true) ;
		en_trop ('upload_pdf/', true) ;
		en_trop ('upload_prot/', true) ;
		}
		
	function en_trop ($dir, $supp = false)
		{
		echo "<p> - - - - - - - - -  $dir ";
		foreach(glob($dir.'*.*') as $v)
			{
			$d3= explode("/",$v);
			$a1=$d3[1];
			$d3= explode(".",$a1);
			$a=abs($d3[0]);			
			$r1 = command("","SELECT * FROM r_attachement where num regexp '$a.' ");
			if ($donnees = mysql_fetch_array($r1) ) // affiner le test en ajoutant que cela commence par $as
				{}
			else 
				{

				echo "<br> $a1 !!! ;";
				if ($supp) 
					{
					supp_fichier($v);	
					echo " --> Supprimé. ;";
					}					
				}
			}
		}
	
		
// backup_tables('localhost','username','password','blog');
/* backup the db OR just a table */
function backup_tables($tables = '*')
{

	//get all of the tables
	if($tables == '*')
	{
		$tables = array();
		$result = mysql_query('SHOW TABLES');
		while($row = mysql_fetch_row($result))
		{
			$tables[] = $row[0];
		}
	}
	else
	{
		$tables = is_array($tables) ? $tables : explode(',',$tables);
	}
	$return="";
	//cycle through
	foreach($tables as $table)
	{
		$result = mysql_query('SELECT * FROM '.$table);
		$num_fields = mysql_num_fields($result);
		
		$return.= 'DROP TABLE '.$table.';';
		$row2 = mysql_fetch_row(mysql_query('SHOW CREATE TABLE '.$table));
		$return.= "\n\n".$row2[1].";\n\n";
		
		for ($i = 0; $i < $num_fields; $i++) 
		{
			while($row = mysql_fetch_row($result))
			{
				$return.= 'INSERT INTO '.$table.' VALUES(';
				for($j=0; $j<$num_fields; $j++) 
				{
					$row[$j] = addslashes($row[$j]);
					$row[$j] = preg_replace("#\n#", "\\n", $row[$j]);
					if (isset($row[$j])) { $return.= '"'.$row[$j].'"' ; } else { $return.= '""'; }
					if ($j<($num_fields-1)) { $return.= ','; }
				}
				$return.= ");\n";
			}
		}
		$return.="\n\n\n";
	}
	
	//save file
	$date=date('Y-m-d G-i',  mktime( date("G"),date("i"),0 , date("m"), date("d"), date ("Y")));

	$file_name='db-backup-'.$date.'.sql';
	$handle = fopen($file_name,'w+');
	fwrite($handle,$return);
	fclose($handle);
	encrypt_fichier($file_name,'backup_chi/'.$file_name.'.chi');
	supp_fichier($file_name);
}

function purge_backup_tables()
	{
	// purge des archive de la bdD de plus d'un mois
	$dir = 'backup_chi/';
	$date=date('Y-m-d',  mktime(0,0,0 , date("m")-1, date("d"), date ("Y")));
	foreach(glob($dir.'*.*') as $v)
		{
		if (date ("Y-m-d", filemtime($v))<$date)
				unlink($v);
		}
	}
	
	?>